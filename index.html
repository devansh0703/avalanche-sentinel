<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalanche Sentinel - V3</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; line-height: 1.6; margin: 0; padding: 2em; background: #f9f9fb; color: #1a1a1a; }
        main { max-width: 960px; margin: 0 auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { text-align: center; color: #000; border-bottom: 1px solid #eee; padding-bottom: 0.5em;}
        textarea { width: 100%; font-family: 'SF Mono', 'Fira Code', 'Menlo', monospace; font-size: 14px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; resize: vertical; }
        #codeInput { min-height: 300px; }
        #genesisInput { min-height: 150px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin: 1.5em 0; padding: 1em; background-color: #f7f7f7; border-radius: 6px; }
        select, button { font-size: 16px; padding: 10px 15px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; }
        button:disabled { cursor: not-allowed; background: #e9e9e9; color: #999; }
        #analyzeButton { background: #d82a2a; color: #fff; border-color: #d82a2a; font-weight: bold; }
        #status { text-align: center; font-weight: bold; padding: 0.5em; border-radius: 4px; }
        .status-idle { color: #555; }
        .status-progress { color: #337ab7; background-color: #e7f3fe; }
        .status-complete { color: #3c763d; background-color: #dff0d8; }
        .status-error { color: #a94442; background-color: #f2dede; }
        #results { border: 1px solid #eee; padding: 0 1em; margin-top: 1em; min-height: 100px; background: #fafafa; font-family: 'SF Mono', 'Fira Code', 'Menlo', monospace; font-size: 13px; border-radius: 6px; }
        .issue { border-bottom: 1px solid #e5e5e5; padding: 1em 0; }
        .issue:last-child { border-bottom: none; }
        .issue-title { font-weight: bold; margin-bottom: 0.5em; display: block; }
        .issue-recommendation { background: #f0f0f0; padding: 0.5em; border-radius: 4px; margin-top: 0.5em; }
        .issue strong { color: #333; }
        .issue-type-critical, .issue-type-security { color: #d9534f; }
        .issue-type-portability { color: #5bc0de; }
        .issue-type-awm { color: #f0ad4e; }
        .issue-type-staking { color: #337ab7; }
        .issue-type-gas { color: #5cb85c; }
        .issue-type-upgrade { color: #777; }
        .issue-type-ecosystem { color: #6f5499; }
        .issue-type-consensus { color: #d9534f; }
        #genesisContainer { display: none; margin-top: 1em; }
    </style>
</head>
<body>
    <main>
        <h1>Avalanche Sentinel V3</h1>
        <p>A complete, Avalanche-native smart contract auditing platform. Paste your Solidity code, select an analysis type, and get an instant, in-depth report from our specialized backend workers.</p>
        
        <textarea id="codeInput" placeholder="pragma solidity ^0.8.20; ..."></textarea>

        <div id="genesisContainer">
            <h3>Subnet Genesis (Optional)</h3>
            <p>For Portability and Gas analysis, you can provide the target Subnet's `genesis.json` to get context-aware results.</p>
            <textarea id="genesisInput" placeholder='{ "config": { "feeConfig": { "gasLimit": 8000000, "minBaseFee": 25000000000 } } ... }'></textarea>
        </div>

        <div class="controls">
            <div>
                <label for="analysisType">Analysis Type:</label>
                <select id="analysisType">
                    <option value="security">Core Security (V2.1)</option>
                    <option value="portability">Subnet Portability (V3)</option>
                    <option value="awm">AWM Interoperability (V3)</option>
                    <option value="staking">Staking Precompile (V3)</option>
                    <option value="consensus">Consensus Compliance (V3)</option>
                    <option value="gas">Gas & Fee Market (V3)</option>
                    <option value="upgrade">Upgradeability & Governance (V3)</option>
                    <option value="ecosystem">Ecosystem & Dependency (V3)</option>
                </select>
            </div>
            <button id="analyzeButton">Analyze</button>
        </div>

        <div id="status" class="status-idle">Status: Idle</div>

        <h2>Results</h2>
        <div id="results">
            <p style="font-family: sans-serif; color: #777;">Analysis results will appear here.</p>
        </div>
    </main>

    <script>
        const codeInput = document.getElementById('codeInput');
        const analysisTypeSelect = document.getElementById('analysisType');
        const analyzeButton = document.getElementById('analyzeButton');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const genesisContainer = document.getElementById('genesisContainer');
        const genesisInput = document.getElementById('genesisInput');
        
        let socket;

        const updateStatus = (text, className) => {
            statusDiv.textContent = `Status: ${text}`;
            statusDiv.className = className;
        };

        const toggleGenesisInput = () => {
            const selectedType = analysisTypeSelect.value;
            if (selectedType === 'portability' || selectedType === 'gas') {
                genesisContainer.style.display = 'block';
            } else {
                genesisContainer.style.display = 'none';
            }
        };

        analysisTypeSelect.addEventListener('change', toggleGenesisInput);
        
        analyzeButton.addEventListener('click', () => {
            const sourceCode = codeInput.value;
            const analysisType = analysisTypeSelect.value;

            if (!sourceCode.trim()) {
                alert('Please paste your Solidity code.');
                return;
            }

            let subnetGenesis = null;
            if (genesisContainer.style.display === 'block' && genesisInput.value.trim()) {
                try {
                    subnetGenesis = JSON.parse(genesisInput.value);
                } catch (e) {
                    alert('The Subnet Genesis is not valid JSON. Please correct it or leave it blank.');
                    return;
                }
            }
            
            connectAndAnalyze(sourceCode, analysisType, subnetGenesis);
        });

        function connectAndAnalyze(sourceCode, analysisType, subnetGenesis) {
            analyzeButton.disabled = true;
            updateStatus('Connecting to Gateway...', 'status-progress');
            resultsDiv.innerHTML = '<p style="font-family: sans-serif; color: #777;">Analysis in progress...</p>';

            socket = new WebSocket('ws://127.0.0.1:8080');

            socket.onopen = () => {
                updateStatus('Connected. Sending job...', 'status-progress');
                const payload = {
                    source_code: sourceCode,
                    analysis_type: analysisType,
                };
                if (subnetGenesis) {
                    payload.subnet_genesis = subnetGenesis;
                }
                socket.send(JSON.stringify(payload));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.status && data.status.includes('Dispatched')) {
                    updateStatus(`Job Dispatched (${data.jobId}). Awaiting analysis...`, 'status-progress');
                } else if (data.worker_name) {
                    updateStatus(`Analysis Complete (Worker: ${data.worker_name})`, 'status-complete');
                    renderResults(data);
                    socket.close();
                } else {
                    updateStatus('Received unknown message.', 'status-error');
                    console.warn("Unknown message:", data);
                }
            };

            socket.onclose = () => {
                updateStatus('Idle (Connection Closed)', 'status-idle');
                analyzeButton.disabled = false;
            };

            socket.onerror = (error) => {
                updateStatus('Error! Could not connect to the backend gateway.', 'status-error');
                resultsDiv.innerHTML = `<p style="color: red; font-family: sans-serif;"><strong>Connection Error:</strong> Please ensure all 9 backend services (1 Gateway + 8 Workers) are running.</p>`;
                console.error('WebSocket Error:', error);
                analyzeButton.disabled = false;
            };
        }

        function renderResults(data) {
            resultsDiv.innerHTML = ''; 

            const workerName = data.worker_name || '';
            const output = data.output;

            if (output.error) {
                resultsDiv.innerHTML = `<p style="color: red; font-family: sans-serif;"><strong>Analysis Error:</strong><br><pre>${output.error}</pre></p><p style="font-family: sans-serif;">${output.recommendation || ''}</p>`;
                return;
            }
            
            if (!output || (Array.isArray(output) && output.length === 0)) {
                 resultsDiv.innerHTML = '<p style="color: green; font-family: sans-serif;"><strong>No issues found!</strong></p>';
                 return;
            }

            if (workerName.toLowerCase().includes('security')) {
                renderSecurityResults(output);
            } else if (workerName.toLowerCase().includes('gas')) {
                renderGasResults(output);
            } else {
                renderStandardResults(output, workerName);
            }
        }
        
        function renderStandardResults(output, workerName) {
            const type = workerName.toLowerCase().replace('v3','').replace('v2','').replace('worker','');
            output.forEach(issue => {
                const issueDiv = document.createElement('div');
                issueDiv.className = 'issue';
                const typeClass = `issue-type-${type}`;
                
                issueDiv.innerHTML = `
                    <span class="issue-title ${typeClass}">[${issue.issue_type}]</span>
                    <div><strong>Description:</strong> ${issue.description}</div>
                    <div class="issue-recommendation"><strong>Recommendation:</strong> ${issue.recommendation}</div>
                `;
                resultsDiv.appendChild(issueDiv);
            });
        }
        
        function renderSecurityResults(output) {
            let foundIssues = false;
            if (output.informational_findings && output.informational_findings.length > 0) {
                 output.informational_findings.forEach(warn => {
                    foundIssues = true;
                    const issueDiv = document.createElement('div');
                    issueDiv.className = 'issue';
                    issueDiv.innerHTML = `
                        <span class="issue-title issue-type-security">[${warn.finding_type}]</span>
                        <pre>${warn.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
                    `;
                    resultsDiv.appendChild(issueDiv);
                });
            }
            if (output.slither_report && output.slither_report.results && output.slither_report.results.detectors.length > 0) {
                 output.slither_report.results.detectors.forEach(detector => {
                     foundIssues = true;
                     const issueDiv = document.createElement('div');
                     issueDiv.className = 'issue';
                     issueDiv.innerHTML = `
                        <span class="issue-title issue-type-security">[Slither: ${detector.check} - Impact: ${detector.impact}]</span>
                        <div><strong>Description:</strong> ${detector.description.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                    `;
                    resultsDiv.appendChild(issueDiv);
                 });
            } else if (output.slither_report && output.slither_report.success === false) {
                 foundIssues = true;
                 resultsDiv.innerHTML += `<p style="color: red; font-family: sans-serif;"><strong>Slither Analysis Error:</strong><br><pre>${output.slither_report.error}</pre></p>`;
            }
            if (!foundIssues) {
                resultsDiv.innerHTML = '<p style="color: green; font-family: sans-serif;"><strong>No issues found!</strong></p>';
            }
        }

        function renderGasResults(output) {
            output.forEach(contractResult => {
                let html = `<div class="issue"><h3>Contract: ${contractResult.contractName}</h3>`;
                html += `<div><strong>Deployment Cost:</strong> ${contractResult.deploymentCost} gas</div>`;
                
                if (contractResult.functionProfiles && contractResult.functionProfiles.length > 0) {
                    html += '<h4>Function Profiles:</h4>';
                    contractResult.functionProfiles.forEach(func => {
                        html += `<div>- <strong>${func.functionName}</strong>: ${func.gasCost} gas ${func.subnetFeeComparison ? `<br>&nbsp;&nbsp;<em>${func.subnetFeeComparison}</em>`: ''}</div>`;
                    });
                }

                if (contractResult.optimizationIssues && contractResult.optimizationIssues.length > 0) {
                    html += '<h4>Optimization Issues Found:</h4>';
                    contractResult.optimizationIssues.forEach(issue => {
                         html += `<div style="margin-top: 1em;">
                            <span class="issue-title issue-type-gas">[${issue.issue_type}]</span>
                            <div><strong>Description:</strong> ${issue.description}</div>
                            <div class="issue-recommendation"><strong>Recommendation:</strong> ${issue.recommendation}</div>
                         </div>`;
                    });
                }
                html += `</div>`;
                resultsDiv.innerHTML += html;
            });
        }
        
        // Initial setup
        toggleGenesisInput();
    </script>
</body>
</html>
